import { useState, useEffect, useRef } from 'react';
import { useParams, useLocation } from 'react-router-dom';
import { getSkillById, getSectionById } from '../api/exams.api';
import TestLayout from '../components/TestLayout';
import './ReadingTest.css';

const containsInlinePlaceholders = (text) => /\{\{\s*[a-zA-Z0-9]+\s*\}\}/.test(text || '');

const GroupContentWithInlineInputs = ({ content, questions = [], answers = {}, onAnswerChange }) => {
  const containerRef = useRef(null);
  const placeholdersMetaRef = useRef([]);
  const latestHandlerRef = useRef(onAnswerChange);

  useEffect(() => {
    latestHandlerRef.current = onAnswerChange;
  }, [onAnswerChange]);

  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;

    if (!content) {
      container.innerHTML = '';
      placeholdersMetaRef.current = [];
      return;
    }

    const placeholderRegex = /\{\{\s*([a-zA-Z0-9]+)\s*\}\}/g;
    const placeholderMeta = [];
    let questionIndex = 0;

    const processedContent = content.replace(placeholderRegex, (match) => {
      const question = questions[questionIndex];
      questionIndex += 1;

      if (!question) {
        return match;
      }

      const placeholderId = `inline-placeholder-${question.id}`;
      placeholderMeta.push({ placeholderId, question });
      return `<span class="reading-test__inline-placeholder" data-placeholder-id="${placeholderId}"></span>`;
    });

    container.innerHTML = processedContent;

    placeholderMeta.forEach((meta) => {
      const placeholderElement = container.querySelector(`[data-placeholder-id="${meta.placeholderId}"]`);
      if (!placeholderElement) return;

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'reading-test__inline-input';
      input.placeholder = meta.question.number?.toString() || '';
      input.maxLength = 50;
      input.dataset.questionId = meta.question.id;

      const handleInput = (event) => {
        latestHandlerRef.current?.(meta.question.id, event.target.value);
      };

      const stopPropagation = (event) => event.stopPropagation();

      input.addEventListener('input', handleInput);
      input.addEventListener('focus', stopPropagation);
      input.addEventListener('click', stopPropagation);

      const wrapper = document.createElement('span');
      wrapper.className = 'reading-test__inline-input-wrapper';
      wrapper.appendChild(input);

      placeholderElement.replaceWith(wrapper);

      meta.input = input;
      meta.cleanup = () => {
        input.removeEventListener('input', handleInput);
        input.removeEventListener('focus', stopPropagation);
        input.removeEventListener('click', stopPropagation);
      };
    });

    placeholdersMetaRef.current = placeholderMeta;

    return () => {
      placeholderMeta.forEach((meta) => meta.cleanup?.());
    };
  }, [content, questions]);

  useEffect(() => {
    placeholdersMetaRef.current.forEach(({ question, input }) => {
      if (!input) return;
      const nextValue = answers?.[question.id] || '';
      if (input.value !== nextValue) {
        input.value = nextValue;
      }
    });
  }, [answers]);

  return (
    <div
      className="reading-test__group-content-parsed"
      ref={containerRef}
    />
  );
};

export default function ReadingTest() {
  const { skillId, sectionId } = useParams();
  const location = useLocation();
  const examData = location.state?.examData;

  // State để quản lý câu hỏi hiện tại và câu trả lời
  const [answers, setAnswers] = useState({});
  const [timeRemaining, setTimeRemaining] = useState(1800); // 30 phút = 1800 giây
  const [currentPartTab, setCurrentPartTab] = useState(1); // Tab hiện tại
  const [loading, setLoading] = useState(true);
  const [skillData, setSkillData] = useState(null);
  const [sectionData, setSectionData] = useState(null);
  const [questionGroups, setQuestionGroups] = useState([]); // Lưu theo groups
  const [passages, setPassages] = useState([]); // Nhiều passages theo part
  const [parts, setParts] = useState([]); // Danh sách các parts

  // Lấy dữ liệu từ API
  useEffect(() => {
    const fetchExamData = async () => {
      try {
        setLoading(true);
        
        if (sectionId) {
          // Lấy data cho section cụ thể (1 part)
          const response = await getSectionById(sectionId, { with_questions: true });
          if (response.data.success) {
            const section = response.data.data;
            setSectionData(section);
            
            // Lấy passage content từ section
            setPassages([{
              id: section.id,
              part: 1,
              title: section.title || 'Reading Passage',
              subtitle: '',
              content: section.content || ''
            }]);
            
            setParts([{ id: section.id, part: 1, title: `Part 1 (1-${section.question_groups?.reduce((sum, g) => sum + (g.questions?.length || 0), 0) || 0})` }]);
            
            // Lấy question groups
            const allGroups = [];
            let questionNumber = 1;
            if (section.question_groups) {
              section.question_groups.forEach(group => {
                console.log('Question Group:', group); // Debug
                const questions = [];
                if (group.questions) {
                  group.questions.forEach((q) => {
                    questions.push({
                      id: q.id,
                      number: questionNumber++,
                      content: q.content,
                      correctAnswer: q.answer_content
                    });
                  });
                }
                
                allGroups.push({
                  id: group.id,
                  part: 1,
                  type: group.question_type || 'TRUE_FALSE_NOT_GIVEN',
                  instructions: group.instructions,
                  groupContent: group.content, // Thêm group content
                  options: Array.isArray(group.options) 
                    ? group.options 
                    : (group.options ? (typeof group.options === 'string' ? JSON.parse(group.options) : ['True', 'False', 'Not given']) : ['True', 'False', 'Not given']),
                  questions: questions,
                  startNumber: questions[0]?.number || 1,
                  endNumber: questions[questions.length - 1]?.number || 1
                });
              });
            }
            console.log('All Question Groups (section):', allGroups); // Debug
            setQuestionGroups(allGroups);
          }
        } else if (skillId) {
          // Lấy data cho full test (nhiều parts/sections)
          const response = await getSkillById(skillId, { with_sections: true });
          if (response.data.success) {
            const skill = response.data.data;
            setSkillData(skill);
            
            // Lấy tất cả question groups từ tất cả sections
            const allGroups = [];
            const allPassages = [];
            const allParts = [];
            let questionNumber = 1;
            
            if (skill.sections && skill.sections.length > 0) {
              skill.sections.forEach((section, sectionIndex) => {
                const partNumber = sectionIndex + 1;
                const groupStartIndex = allGroups.length;
                
                // Lưu passage cho mỗi part
                allPassages.push({
                  id: section.id,
                  part: partNumber,
                  title: section.title || `Reading Passage ${partNumber}`,
                  subtitle: '',
                  content: section.content || ''
                });
                
                // Lấy question groups
                if (section.question_groups) {
                  section.question_groups.forEach(group => {
                    console.log('Question Group (full test):', group); // Debug
                    const questions = [];
                    if (group.questions) {
                      group.questions.forEach((q) => {
                        questions.push({
                          id: q.id,
                          number: questionNumber++,
                          content: q.content,
                          correctAnswer: q.answer_content
                        });
                      });
                    }
                    
                    allGroups.push({
                      id: group.id,
                      part: partNumber,
                      type: group.question_type || 'TRUE_FALSE_NOT_GIVEN',
                      instructions: group.instructions,
                      groupContent: group.content, // Thêm group content
                      options: Array.isArray(group.options) 
                        ? group.options 
                        : (group.options ? (typeof group.options === 'string' ? JSON.parse(group.options) : ['True', 'False', 'Not given']) : ['True', 'False', 'Not given']),
                      questions: questions,
                      startNumber: questions[0]?.number || questionNumber,
                      endNumber: questions[questions.length - 1]?.number || questionNumber
                    });
                  });
                }
                
                const firstQuestionNum = allGroups[groupStartIndex]?.startNumber || questionNumber;
                const lastQuestionNum = allGroups[allGroups.length - 1]?.endNumber || questionNumber;
                allParts.push({
                  id: section.id,
                  part: partNumber,
                  title: `Part ${partNumber} (${firstQuestionNum}-${lastQuestionNum})`
                });
              });
              
              console.log('All Question Groups (full test):', allGroups); // Debug
              setPassages(allPassages);
              setParts(allParts);
            }
            
            setQuestionGroups(allGroups);
            
            // Set thời gian từ skill
            if (skill.time_limit) {
              setTimeRemaining(skill.time_limit * 60); // Convert minutes to seconds
            }
          }
        }
      } catch (error) {
        console.error('Error fetching exam data:', error);
        alert('Không thể tải dữ liệu bài thi. Vui lòng thử lại.');
      } finally {
        setLoading(false);
      }
    };

    fetchExamData();
  }, [skillId, sectionId]);

  // Xử lý chọn đáp án
  const handleAnswerSelect = (questionId, answer) => {
    setAnswers({
      ...answers,
      [questionId]: answer
    });
  };

  // Xử lý nộp bài
  const handleSubmit = () => {
    // TODO: Gửi kết quả về server
    const result = {
      skillId,
      sectionId,
      answers,
      timeSpent: (skillData?.time_limit * 60 || 1800) - timeRemaining
    };
    console.log('Submit result:', result);
  };

  // Loading state
  if (loading) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
        <div style={{ textAlign: 'center' }}>
          <div style={{ fontSize: '18px', color: '#6B7280', marginBottom: '16px' }}>
            Đang tải dữ liệu bài thi...
          </div>
        </div>
      </div>
    );
  }

  // Error state
  if (!passages || passages.length === 0 || questionGroups.length === 0) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
        <div style={{ textAlign: 'center' }}>
          <div style={{ fontSize: '18px', color: '#EF4444', marginBottom: '16px' }}>
            Không tìm thấy dữ liệu bài thi
          </div>
        </div>
      </div>
    );
  }

  const currentPassage = passages.find(p => p.part === currentPartTab) || passages[0];
  const currentPartGroups = questionGroups.filter(g => g.part === currentPartTab);

  // Render câu hỏi dựa trên loại question type
  const renderQuestionsByType = (group, answers, handleAnswerSelect) => {
    const questionType = (group.type || '').toLowerCase();
    console.log('Question Type:', questionType);

    // 1. DẠNG SHORT_TEXT - Điền vào chỗ trống inline (có {{ placeholders }})
    const hasPlaceholders = containsInlinePlaceholders(group.groupContent);
    if (hasPlaceholders || questionType === 'short_text') {
      // Nếu có placeholders, render groupContent với inline inputs
      if (hasPlaceholders) {
        return (
          <div className="reading-test__question-group-with-inputs">
            <GroupContentWithInlineInputs
              content={group.groupContent}
              questions={group.questions}
              answers={answers}
              onAnswerChange={handleAnswerSelect}
            />
          </div>
        );
      }
      
      // Nếu không có placeholders, render input riêng lẻ
      return group.questions.map((question) => (
        <div key={question.id} className="reading-test__question-item reading-test__question-item--input">
          <div className="reading-test__question-row">
            <div className="reading-test__question-number">
              {question.number}
            </div>
            <div
              className="reading-test__question-text"
              dangerouslySetInnerHTML={{ __html: question.content }}
            />
          </div>
          <div className="reading-test__answer-input-wrapper">
            <input
              type="text"
              className="reading-test__answer-input"
              placeholder="Type your answer here..."
              value={answers[question.id] || ''}
              onChange={(e) => handleAnswerSelect(question.id, e.target.value)}
              maxLength={100}
            />
          </div>
        </div>
      ));
    }

    // 2. DẠNG MULTIPLE_CHOICE - Trắc nghiệm (chọn A, B, C, D...)
    if (questionType === 'multiple_choice') {
      return group.questions.map((question) => (
        <div key={question.id} className="reading-test__question-item">
          <div className="reading-test__question-row">
            <div className="reading-test__question-number">
              {question.number}
            </div>
            <div
              className="reading-test__question-text"
              dangerouslySetInnerHTML={{ __html: question.content }}
            />
          </div>
          <div className="reading-test__options reading-test__options--grid">
            {group.options.map((option) => (
              <label
                key={option}
                className={`reading-test__option reading-test__option--box ${
                  answers[question.id] === option ? 'selected' : ''
                }`}
              >
                <input
                  type="radio"
                  name={`question-${question.id}`}
                  value={option}
                  checked={answers[question.id] === option}
                  onChange={() => handleAnswerSelect(question.id, option)}
                />
                <span className="reading-test__option-text">{option}</span>
              </label>
            ))}
          </div>
        </div>
      ));
    }

    // 3. DẠNG YES_NO_NOT_GIVEN - Yes/No/Not Given
    if (questionType === 'yes_no_not_given') {
      return group.questions.map((question) => (
        <div key={question.id} className="reading-test__question-item">
          <div className="reading-test__question-row">
            <div className="reading-test__question-number">
              {question.number}
            </div>
            <div
              className="reading-test__question-text"
              dangerouslySetInnerHTML={{ __html: question.content }}
            />
          </div>
          <div className="reading-test__options">
            {(group.options || ['Yes', 'No', 'Not Given']).map((option) => (
              <label
                key={option}
                className={`reading-test__option ${
                  answers[question.id] === option ? 'selected' : ''
                }`}
              >
                <input
                  type="radio"
                  name={`question-${question.id}`}
                  value={option}
                  checked={answers[question.id] === option}
                  onChange={() => handleAnswerSelect(question.id, option)}
                />
                <span className="reading-test__option-text">{option}</span>
              </label>
            ))}
          </div>
        </div>
      ));
    }

    // 4. DẠNG TRUE_FALSE_NOT_GIVEN - True/False/Not Given
    if (questionType === 'true_false_not_given') {
      return group.questions.map((question) => (
        <div key={question.id} className="reading-test__question-item">
          <div className="reading-test__question-row">
            <div className="reading-test__question-number">
              {question.number}
            </div>
            <div
              className="reading-test__question-text"
              dangerouslySetInnerHTML={{ __html: question.content }}
            />
          </div>
          <div className="reading-test__options">
            {(group.options || ['True', 'False', 'Not Given']).map((option) => (
              <label
                key={option}
                className={`reading-test__option ${
                  answers[question.id] === option ? 'selected' : ''
                }`}
              >
                <input
                  type="radio"
                  name={`question-${question.id}`}
                  value={option}
                  checked={answers[question.id] === option}
                  onChange={() => handleAnswerSelect(question.id, option)}
                />
                <span className="reading-test__option-text">{option}</span>
              </label>
            ))}
          </div>
        </div>
      ));
    }

    // 5. DẠNG TABLE_SELECTION - Chọn từ bảng/dropdown
    if (questionType === 'table_selection') {
      return group.questions.map((question) => (
        <div key={question.id} className="reading-test__question-item reading-test__question-item--matching">
          <div className="reading-test__question-row">
            <div className="reading-test__question-number">
              {question.number}
            </div>
            <div
              className="reading-test__question-text"
              dangerouslySetInnerHTML={{ __html: question.content }}
            />
          </div>
          <div className="reading-test__matching-select">
            <select
              className="reading-test__select"
              value={answers[question.id] || ''}
              onChange={(e) => handleAnswerSelect(question.id, e.target.value)}
            >
              <option value="">Select...</option>
              {group.options.map((option) => (
                <option key={option} value={option}>
                  {option}
                </option>
              ))}
            </select>
          </div>
        </div>
      ));
    }

    // Mặc định fallback - nếu không match type nào
    console.warn('Unknown question type:', questionType);
    return group.questions.map((question) => (
      <div key={question.id} className="reading-test__question-item">
        <div className="reading-test__question-row">
          <div className="reading-test__question-number">
            {question.number}
          </div>
          <div
            className="reading-test__question-text"
            dangerouslySetInnerHTML={{ __html: question.content }}
          />
        </div>
        <div className="reading-test__options">
          {(group.options || []).map((option) => (
            <label
              key={option}
              className={`reading-test__option ${
                answers[question.id] === option ? 'selected' : ''
              }`}
            >
              <input
                type="radio"
                name={`question-${question.id}`}
                value={option}
                checked={answers[question.id] === option}
                onChange={() => handleAnswerSelect(question.id, option)}
              />
              <span className="reading-test__option-text">{option}</span>
            </label>
          ))}
        </div>
      </div>
    ));
  };
  
  return (
    <div className="reading-test">
      {/* Header */}
      <div className="reading-test__header">
        <button className="reading-test__close" onClick={() => navigate(-1)}>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
          </svg>
        </button>
        <div className="reading-test__header-info">
          <img src="/src/assets/images/logo.png" alt="OWL IELTS" className="reading-test__logo" />
          <div className="reading-test__header-text">
            <div className="reading-test__header-label">Làm bài passage {currentPartTab}</div>
            <div className="reading-test__header-name">
              {examData?.name || skillData?.name || sectionData?.title || 'Reading Test'}
            </div>
          </div>
        </div>
        <div className="reading-test__header-right">
          {/* Font Size Icon Button */}
          <div className="reading-test__font-size-wrapper">
            <button 
              className={`reading-test__font-size-button ${showFontSizeModal ? 'active' : ''}`}
              onClick={() => setShowFontSizeModal(!showFontSizeModal)}
              title="Cỡ chữ"
            >
              <span className="reading-test__font-size-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M7.74102 11.0753L3.33268 15.492V14.167C3.33268 13.946 3.24488 13.734 3.0886 13.5777C2.93232 13.4215 2.72036 13.3337 2.49935 13.3337C2.27834 13.3337 2.06637 13.4215 1.91009 13.5777C1.75381 13.734 1.66602 13.946 1.66602 14.167V17.5003C1.66733 17.6092 1.68998 17.7168 1.73268 17.817C1.81724 18.0206 1.97906 18.1824 2.18268 18.267C2.28287 18.3097 2.39045 18.3323 2.49935 18.3337H5.83268C6.0537 18.3337 6.26566 18.2459 6.42194 18.0896C6.57822 17.9333 6.66602 17.7213 6.66602 17.5003C6.66602 17.2793 6.57822 17.0673 6.42194 16.9111C6.26566 16.7548 6.0537 16.667 5.83268 16.667H4.50768L8.92435 12.2587C9.08127 12.1017 9.16943 11.8889 9.16943 11.667C9.16943 11.4451 9.08127 11.2322 8.92435 11.0753C8.76743 10.9184 8.5546 10.8302 8.33268 10.8302C8.11076 10.8302 7.89794 10.9184 7.74102 11.0753ZM4.50768 3.33366H5.83268C6.0537 3.33366 6.26566 3.24586 6.42194 3.08958C6.57822 2.9333 6.66602 2.72134 6.66602 2.50033C6.66602 2.27931 6.57822 2.06735 6.42194 1.91107C6.26566 1.75479 6.0537 1.66699 5.83268 1.66699H2.49935C2.39045 1.66831 2.28287 1.69096 2.18268 1.73366C1.97906 1.81822 1.81724 1.98003 1.73268 2.18366C1.68998 2.28384 1.66733 2.39143 1.66602 2.50033V5.83366C1.66602 6.05467 1.75381 6.26663 1.91009 6.42291C2.06637 6.57919 2.27834 6.66699 2.49935 6.66699C2.72036 6.66699 2.93232 6.57919 3.0886 6.42291C3.24488 6.26663 3.33268 6.05467 3.33268 5.83366V4.50866L7.74102 8.92533C7.81848 9.00343 7.91065 9.06543 8.0122 9.10773C8.11375 9.15004 8.22267 9.17182 8.33268 9.17182C8.44269 9.17182 8.55161 9.15004 8.65316 9.10773C8.75471 9.06543 8.84688 9.00343 8.92435 8.92533C9.00246 8.84786 9.06445 8.75569 9.10676 8.65414C9.14907 8.55259 9.17085 8.44367 9.17085 8.33366C9.17085 8.22365 9.14907 8.11473 9.10676 8.01318C9.06445 7.91163 9.00246 7.81946 8.92435 7.74199L4.50768 3.33366ZM17.4993 13.3337C17.2783 13.3337 17.0664 13.4215 16.9101 13.5777C16.7538 13.734 16.666 13.946 16.666 14.167V15.492L12.2577 11.0753C12.1008 10.9184 11.8879 10.8302 11.666 10.8302C11.4441 10.8302 11.2313 10.9184 11.0743 11.0753C10.9174 11.2322 10.8293 11.4451 10.8293 11.667C10.8293 11.8889 10.9174 12.1017 11.0743 12.2587L15.491 16.667H14.166C13.945 16.667 13.733 16.7548 13.5768 16.9111C13.4205 17.0673 13.3327 17.2793 13.3327 17.5003C13.3327 17.7213 13.4205 17.9333 13.5768 18.0896C13.733 18.2459 13.945 18.3337 14.166 18.3337H17.4993C17.6082 18.3323 17.7158 18.3097 17.816 18.267C18.0196 18.1824 18.1815 18.0206 18.266 17.817C18.3087 17.7168 18.3314 17.6092 18.3327 17.5003V14.167C18.3327 13.946 18.2449 13.734 18.0886 13.5777C17.9323 13.4215 17.7204 13.3337 17.4993 13.3337ZM18.266 2.18366C18.1815 1.98003 18.0196 1.81822 17.816 1.73366C17.7158 1.69096 17.6082 1.66831 17.4993 1.66699H14.166C13.945 1.66699 13.733 1.75479 13.5768 1.91107C13.4205 2.06735 13.3327 2.27931 13.3327 2.50033C13.3327 2.72134 13.4205 2.9333 13.5768 3.08958C13.733 3.24586 13.945 3.33366 14.166 3.33366H15.491L11.0743 7.74199C10.9962 7.81946 10.9342 7.91163 10.8919 8.01318C10.8496 8.11473 10.8279 8.22365 10.8279 8.33366C10.8279 8.44367 10.8496 8.55259 10.8919 8.65414C10.9342 8.75569 10.9962 8.84786 11.0743 8.92533C11.1518 9.00343 11.244 9.06543 11.3455 9.10773C11.4471 9.15004 11.556 9.17182 11.666 9.17182C11.776 9.17182 11.8849 9.15004 11.9865 9.10773C12.088 9.06543 12.1802 9.00343 12.2577 8.92533L16.666 4.50866V5.83366C16.666 6.05467 16.7538 6.26663 16.9101 6.42291C17.0664 6.57919 17.2783 6.66699 17.4993 6.66699C17.7204 6.66699 17.9323 6.57919 18.0886 6.42291C18.2449 6.26663 18.3327 6.05467 18.3327 5.83366V2.50033C18.3314 2.39143 18.3087 2.28384 18.266 2.18366Z" fill="#4F4F4F"/>
                </svg>
              </span>
              <span className="reading-test__font-size-icon-active">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M7.74102 11.0753L3.33268 15.492V14.167C3.33268 13.946 3.24488 13.734 3.0886 13.5777C2.93232 13.4215 2.72036 13.3337 2.49935 13.3337C2.27834 13.3337 2.06637 13.4215 1.91009 13.5777C1.75381 13.734 1.66602 13.946 1.66602 14.167V17.5003C1.66733 17.6092 1.68998 17.7168 1.73268 17.817C1.81724 18.0206 1.97906 18.1824 2.18268 18.267C2.28287 18.3097 2.39045 18.3323 2.49935 18.3337H5.83268C6.0537 18.3337 6.26566 18.2459 6.42194 18.0896C6.57822 17.9333 6.66602 17.7213 6.66602 17.5003C6.66602 17.2793 6.57822 17.0673 6.42194 16.9111C6.26566 16.7548 6.0537 16.667 5.83268 16.667H4.50768L8.92435 12.2587C9.08127 12.1017 9.16943 11.8889 9.16943 11.667C9.16943 11.4451 9.08127 11.2322 8.92435 11.0753C8.76743 10.9184 8.5546 10.8302 8.33268 10.8302C8.11076 10.8302 7.89794 10.9184 7.74102 11.0753ZM4.50768 3.33366H5.83268C6.0537 3.33366 6.26566 3.24586 6.42194 3.08958C6.57822 2.9333 6.66602 2.72134 6.66602 2.50033C6.66602 2.27931 6.57822 2.06735 6.42194 1.91107C6.26566 1.75479 6.0537 1.66699 5.83268 1.66699H2.49935C2.39045 1.66831 2.28287 1.69096 2.18268 1.73366C1.97906 1.81822 1.81724 1.98003 1.73268 2.18366C1.68998 2.28384 1.66733 2.39143 1.66602 2.50033V5.83366C1.66602 6.05467 1.75381 6.26663 1.91009 6.42291C2.06637 6.57919 2.27834 6.66699 2.49935 6.66699C2.72036 6.66699 2.93232 6.57919 3.0886 6.42291C3.24488 6.26663 3.33268 6.05467 3.33268 5.83366V4.50866L7.74102 8.92533C7.81848 9.00343 7.91065 9.06543 8.0122 9.10773C8.11375 9.15004 8.22267 9.17182 8.33268 9.17182C8.44269 9.17182 8.55161 9.15004 8.65316 9.10773C8.75471 9.06543 8.84688 9.00343 8.92435 8.92533C9.00246 8.84786 9.06445 8.75569 9.10676 8.65414C9.14907 8.55259 9.17085 8.44367 9.17085 8.33366C9.17085 8.22365 9.14907 8.11473 9.10676 8.01318C9.06445 7.91163 9.00246 7.81946 8.92435 7.74199L4.50768 3.33366ZM17.4993 13.3337C17.2783 13.3337 17.0664 13.4215 16.9101 13.5777C16.7538 13.734 16.666 13.946 16.666 14.167V15.492L12.2577 11.0753C12.1008 10.9184 11.8879 10.8302 11.666 10.8302C11.4441 10.8302 11.2313 10.9184 11.0743 11.0753C10.9174 11.2322 10.8293 11.4451 10.8293 11.667C10.8293 11.8889 10.9174 12.1017 11.0743 12.2587L15.491 16.667H14.166C13.945 16.667 13.733 16.7548 13.5768 16.9111C13.4205 17.0673 13.3327 17.2793 13.3327 17.5003C13.3327 17.7213 13.4205 17.9333 13.5768 18.0896C13.733 18.2459 13.945 18.3337 14.166 18.3337H17.4993C17.6082 18.3323 17.7158 18.3097 17.816 18.267C18.0196 18.1824 18.1815 18.0206 18.266 17.817C18.3087 17.7168 18.3314 17.6092 18.3327 17.5003V14.167C18.3327 13.946 18.2449 13.734 18.0886 13.5777C17.9323 13.4215 17.7204 13.3337 17.4993 13.3337ZM18.266 2.18366C18.1815 1.98003 18.0196 1.81822 17.816 1.73366C17.7158 1.69096 17.6082 1.66831 17.4993 1.66699H14.166C13.945 1.66699 13.733 1.75479 13.5768 1.91107C13.4205 2.06735 13.3327 2.27931 13.3327 2.50033C13.3327 2.72134 13.4205 2.9333 13.5768 3.08958C13.733 3.24586 13.945 3.33366 14.166 3.33366H15.491L11.0743 7.74199C10.9962 7.81946 10.9342 7.91163 10.8919 8.01318C10.8496 8.11473 10.8279 8.22365 10.8279 8.33366C10.8279 8.44367 10.8496 8.55259 10.8919 8.65414C10.9342 8.75569 10.9962 8.84786 11.0743 8.92533C11.1518 9.00343 11.244 9.06543 11.3455 9.10773C11.4471 9.15004 11.556 9.17182 11.666 9.17182C11.776 9.17182 11.8849 9.15004 11.9865 9.10773C12.088 9.06543 12.1802 9.00343 12.2577 8.92533L16.666 4.50866V5.83366C16.666 6.05467 16.7538 6.26663 16.9101 6.42291C17.0664 6.57919 17.2783 6.66699 17.4993 6.66699C17.7204 6.66699 17.9323 6.57919 18.0886 6.42291C18.2449 6.26663 18.3327 6.05467 18.3327 5.83366V2.50033C18.3314 2.39143 18.3087 2.28384 18.266 2.18366Z" fill="#045CCE"/>
                </svg>
              </span>
            </button>

            {/* Dropdown Menu */}
            {showFontSizeModal && (
              <div className="reading-test__font-dropdown">
                <h3 className="reading-test__font-dropdown-title">Cỡ chữ</h3>
                <p className="reading-test__font-dropdown-subtitle">Chọn cỡ chữ phù hợp cho việc đọc</p>
                
                <div className="reading-test__font-options">
                  <button
                    className={`reading-test__font-option ${fontSize === 'normal' ? 'active' : ''}`}
                    onClick={() => {
                      setFontSize('normal');
                      setShowFontSizeModal(false);
                    }}
                  >
                    Bình thường
                    {fontSize === 'normal' && (
                      <svg className="reading-test__check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M13.3337 4L6.00033 11.3333L2.66699 8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                    )}
                  </button>
                  
                  <button
                    className={`reading-test__font-option ${fontSize === 'large' ? 'active' : ''}`}
                    onClick={() => {
                      setFontSize('large');
                      setShowFontSizeModal(false);
                    }}
                  >
                    Lớn
                    {fontSize === 'large' && (
                      <svg className="reading-test__check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M13.3337 4L6.00033 11.3333L2.66699 8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                    )}
                  </button>
                  
                  <button
                    className={`reading-test__font-option ${fontSize === 'extra-large' ? 'active' : ''}`}
                    onClick={() => {
                      setFontSize('extra-large');
                      setShowFontSizeModal(false);
                    }}
                  >
                    Rất lớn
                    {fontSize === 'extra-large' && (
                      <svg className="reading-test__check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M13.3337 4L6.00033 11.3333L2.66699 8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                    )}
                  </button>
                </div>
                
                <button 
                  className="reading-test__font-dropdown-close"
                  onClick={() => setShowFontSizeModal(false)}
                >
                  Đóng
                </button>
              </div>
            )}
          </div>
          
          <div className="reading-test__timer">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M10 0C8.35215 0 6.74099 0.488742 5.37058 1.40442C4.00017 2.3201 2.93206 3.62159 2.30133 5.1443C1.6706 6.66702 1.50558 8.34258 1.82712 9.95909C2.14866 11.5756 2.94234 13.0605 4.10777 14.2259C5.27321 15.3913 6.75807 16.185 8.37458 16.5065C9.99109 16.8281 11.6666 16.6631 13.1894 16.0323C14.7121 15.4016 16.0136 14.3335 16.9292 12.9631C17.8449 11.5927 18.3337 9.98151 18.3337 8.33333C18.3337 6.12632 17.456 4.00956 15.8929 2.44628C14.3296 0.883001 12.2128 0 10 0ZM10 15C8.68179 15 7.39286 14.609 6.29654 13.8765C5.20021 13.1439 4.34572 12.1027 3.84114 10.8846C3.33655 9.66638 3.20453 8.32594 3.46176 7.03273C3.719 5.73953 4.35393 4.55164 5.28628 3.61929C6.21863 2.68694 7.40652 2.052 8.69973 1.79477C9.99293 1.53753 11.3334 1.66956 12.5516 2.17414C13.7697 2.67872 14.8109 3.5332 15.5435 4.62953C16.276 5.72586 16.667 7.01479 16.667 8.33333C16.667 10.1014 15.9646 11.7971 14.7144 13.0474C13.4641 14.2976 11.7684 15 10 15Z" fill="#045CCE"/>
              <path d="M10.8333 7.5H9.16667V4.16667C9.16667 3.94565 9.07887 3.73369 8.92259 3.57741C8.76631 3.42113 8.55435 3.33333 8.33334 3.33333C8.11232 3.33333 7.90036 3.42113 7.74408 3.57741C7.5878 3.73369 7.5 3.94565 7.5 4.16667V8.33333C7.5 8.55435 7.5878 8.76631 7.74408 8.92259C7.90036 9.07887 8.11232 9.16667 8.33334 9.16667H10.8333C11.0544 9.16667 11.2663 9.07887 11.4226 8.92259C11.5789 8.76631 11.6667 8.55435 11.6667 8.33333C11.6667 8.11232 11.5789 7.90036 11.4226 7.74408C11.2663 7.5878 11.0544 7.5 10.8333 7.5Z" fill="#045CCE"/>
            </svg>
            <span>{formatTime(timeRemaining)}</span>
          </div>
          <button className="reading-test__submit-button-header" onClick={handleSubmit}>
            Nộp bài
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="reading-test__content">
        <div className="reading-test__content-wrapper">
          {/* Passage Panel */}
          <div className="reading-test__passage">
            <div className="reading-test__passage-header">
              <h2 className="reading-test__passage-title">{currentPassage.title}</h2>
              {currentPassage.subtitle && (
                <p className="reading-test__passage-subtitle">{currentPassage.subtitle}</p>
              )}
            </div>
            <div 
              className={`reading-test__passage-content reading-test__passage-content--${fontSize}`}
              dangerouslySetInnerHTML={{ __html: currentPassage.content }}
            />
          </div>

          {/* Questions Panel */}
          <div className={`reading-test__questions reading-test__questions--${fontSize}`}>
          {/* Render all question groups for current part */}
          {currentPartGroups.map((group) => (
            <div key={group.id} id={`question-group-${group.id}`} className="reading-test__question-group">
              {/* Group Header */}
              <div className="reading-test__group-header">
                <h3>Questions {group.startNumber} - {group.endNumber}</h3>
                {group.instructions && (
                  <div 
                    className="reading-test__group-instructions"
                    dangerouslySetInnerHTML={{ __html: group.instructions }}
                  />
                )}
              </div>

              {/* Group Content - Hiển thị nội dung đầy đủ của question group */}
              {group.groupContent && !(/\{\{\s*[a-zA-Z0-9]+\s*\}\}/g.test(group.groupContent)) && (
                <div
                  className="reading-test__group-content"
                  dangerouslySetInnerHTML={{ __html: group.groupContent }}
                />
              )}

              {/* All Questions in Group */}
              <div className="reading-test__questions-list">
                {renderQuestionsByType(group, answers, handleAnswerSelect)}
              </div>
            </div>
          ))}
        </div>
        </div>
      </div>
      
      {/* Part Tabs và Question Numbers - Fixed ở dưới cùng */}
      <div className="reading-test__footer">
        {/* Part Tabs */}
        {parts.length > 1 && (
          <div className="reading-test__part-tabs">
            {parts.map((part) => {
              // Lấy câu hỏi đầu và cuối của part
              const partGroups = questionGroups.filter(g => g.part === part.part);
              const partQuestions = partGroups.flatMap(g => g.questions);
              const firstQuestion = partQuestions[0]?.number || 1;
              const lastQuestion = partQuestions[partQuestions.length - 1]?.number || 1;
              
              return (
                <button
                  key={part.part}
                  className={`reading-test__part-tab ${currentPartTab === part.part ? 'active' : ''}`}
                  onClick={() => handlePartChange(part.part)}
                >
                  Part {part.part} - {firstQuestion}/{lastQuestion}
                </button>
              );
            })}
          </div>
        )}
        
        {/* Question Numbers Grid - chỉ hiển thị câu của part hiện tại */}
        <div className="reading-test__question-numbers">
          {allQuestionsInPart.map((q) => (
            <button
              key={q.id}
              className={`reading-test__question-number-item ${
                answers[q.id] ? 'answered' : ''
              }`}
              onClick={() => handleQuestionClick(q.number)}
            >
              {q.number}
            </button>
          ))}
        </div>
      </div>

      {/* Submit Modal */}
      {showSubmitModal && (
        <div className="reading-test__modal-overlay" onClick={cancelSubmit}>
          <div className="reading-test__modal-content reading-test__submit-modal" onClick={(e) => e.stopPropagation()}>
            {/* Icon */}
            <div className="reading-test__submit-modal-icon">
              <img 
                src={isTestComplete ? "/src/assets/images/cudaxong.png" : "/src/assets/images/cuchuaxong.png"} 
                alt="Owl" 
                className="reading-test__submit-modal-owl"
              />
            </div>

            {/* Content */}
            <div className="reading-test__submit-modal-body">
              {isTestComplete ? (
                <>
                  <h3 className="reading-test__submit-modal-title">Bạn đã hoàn thành bài thi.</h3>
                  <p className="reading-test__submit-modal-text">Bạn có cần kiểm tra lại không?</p>
                </>
              ) : (
                <>
                  <h3 className="reading-test__submit-modal-title">Bạn vẫn chưa hoàn thành</h3>
                  <p className="reading-test__submit-modal-text">Bạn có chắc muốn nộp bài không?</p>
                </>
              )}
            </div>

            {/* Buttons */}
            <div className="reading-test__submit-modal-actions">
              {isTestComplete ? (
                <>
                  <button 
                    className="reading-test__submit-modal-button reading-test__submit-modal-button--primary"
                    onClick={confirmSubmit}
                  >
                    Nộp bài
                  </button>
                  <button 
                    className="reading-test__submit-modal-button reading-test__submit-modal-button--secondary"
                    onClick={cancelSubmit}
                  >
                    Kiểm tra lại
                  </button>
                </>
              ) : (
                <>
                  <button 
                    className="reading-test__submit-modal-button reading-test__submit-modal-button--primary"
                    onClick={cancelSubmit}
                  >
                    Tiếp tục làm bài
                  </button>
                  <button 
                    className="reading-test__submit-modal-button reading-test__submit-modal-button--secondary"
                    onClick={confirmSubmit}
                  >
                    Nộp bài
                  </button>
                </>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Congratulation Modal */}
      {showCongratulationModal && (
        <div className="reading-test__modal-overlay">
          <div className="reading-test__modal-content reading-test__submit-modal" onClick={(e) => e.stopPropagation()}>
            {/* Icon */}
            <div className="reading-test__submit-modal-icon">
              <img 
                src="/src/assets/images/cuchucmung.png" 
                alt="Owl" 
                className="reading-test__submit-modal-owl"
              />
            </div>

            {/* Content */}
            <div className="reading-test__submit-modal-body">
              <h3 className="reading-test__submit-modal-title">Chúc mừng bạn đã hoàn thành</h3>
            </div>

            {/* Button */}
            <div className="reading-test__submit-modal-actions">
              <button 
                className="reading-test__submit-modal-button reading-test__submit-modal-button--primary"
                onClick={handleContinuePractice}
              >
                Tiếp tục luyện tập
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
